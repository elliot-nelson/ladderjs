{"version":3,"sources":["app.js"],"names":["PLAY_SPEEDS","LEVEL_ORDER","Viewport","[object Object]","canvas","document","getElementById","ctx","getContext","resize","force","dpi","window","devicePixelRatio","width","clientWidth","height","clientHeight","dpiWidth","dpiHeight","scale","Math","min","ceil","center","u","v","imageSmoothingEnabled","fillRect","xy2qr","pos","qrsA","q","r","s","qr2qrs","qrsB","round","diffQ","abs","diffR","diffS","qrs2qr","qrRounded","x","y","rgba","g","b","a","createCanvas","createElement","SpriteSheet","font","font2","harold","base64","Terrain","objects","Sprite","cb","image","Image","onload","src","sheet","initBasicSprite","terrain","keys","Object","filter","key","startsWith","fromEntries","map","parsed","source","loadCacheSlice","drawImage","im","getImageData","floors","Infinity","max","data","console","log","push","globalCompositeOperation","fillStyle","sprite","processTerrain","initDynamicSprite","loadTerrain","img","anchor","rotation","this","viewportSprite2uv","save","translate","rotate","restore","game","camera","w","h","sliceCanvas","KeyboardAdapter","KeyW","Input","Action","UP","KeyA","LEFT","KeyS","DOWN","KeyD","RIGHT","ArrowUp","ArrowLeft","ArrowDown","ArrowRight","Space","JUMP","Escape","MENU","arrowDirections","m","held","addEventListener","event","k","code","buffer","at","Date","getTime","reset","state","direction","action","values","zzfx","t","zzfxP","zzfxG","e","zzfxX","createBufferSource","f","createBuffer","length","zzfxR","d","i","getChannelData","set","connect","destination_","start","c","F","z","A","l","B","G","C","p","PI","H","I","D","random","Z","E","n","J","K","sin","tan","zzfxV","top","AudioContext","webkitAudioContext","destination","ObliqueMystique","Audio","readyToPlay","gain_","createGain","shotgun","page","shellReload","damage","alarm","victory","song","instruments","patterns","sequence","BPM","instrumentParameters","j","note","sample","patternChannel","notFirstBeat","stop","instrument","pitch","attenuation","outSampleOffset","sampleOffset","nextSampleOffset","panning","sampleBuffer","leftChannelBuffer","rightChannelBuffer","channelIndex","hasMore","sampleCache","beatLength","patternIndex","sequenceIndex","zzfxM","localStorage","JSON","stringify","musicPlaying","sound","gain","linearRampToValueAtTime","currentTime","MouseAdapter","ATTACK","RELOAD","pointer","clientX","clientY","undefined","button","preventDefault","releaseRMBTick","MUTE","FREEZE","pressed","released","framesHeld","init","update","now","entry","UNICODE_CHAR_MAP","join","split","reduce","char","idx","Text","white","black","recolor","black_shadow","blue","blue_shadow","shadow","red","terminal","terminal_shadow","text","Array","isArray","block","drawText","charCodeAt","floor","measureWidth","sum","cu","cv","next","wip","list","cWidth","saved","space","pop","line","col","row","splitParagraph","color","Hud","ScreenShake","frames","hAmplitude","vAmplitude","hSamples","vSamples","sampleCount","frame","s0","s1","decay","State","STOPPED","FALLING","START_JUMP","JUMP_LEFT","JUMP_RIGHT","JUMP_UP","DYING","DEAD","JUMP_FRAMES","Entity","field","repeat","nextState","includes","onSolid","jumpStep","isLadder","emptySpace","canClimbUp","canClimbDown","step","layout","applyMovement","Screen","screen","clear","DEATH_FRAMES","Player","super","deathStep","write","DEATH_FRAMES$1","Rock","dispenser","LEVEL_COLS","isEater","Level","LEVELS","name","time","maxRocks","rocks","levelNumber","level","Error","player","dispensers","slice","maRrocks","Field","load","session","oldX","oldY","isDisappearingFloor","checkIfPlayerShouldDie","rock","isStatue","updateScore","isTreasure","startNextLevel","isTrampoline","restartLevel","draw","forEach","isFire","splice","MainMenu","lastKeyPressed","toUpperCase","consume","startSession","playSpeed","showInstructions","highScores","InstructionsMenu","showMainMenu","Session","score","levelCycle","lives","nextLife","recentKeystrokes","match","parseInt","RegExp","$1","stat","String","padStart","scoreType","loadSpritesheet","async","entities","dialogPending","dialogSeen","roomsCleared","shadowOffset","screenshakes","cameraFocus","pause","unpause","fps","frameTimes","menu","requestAnimationFrame","delta","onFrame","desiredFps","lastFrame","handleInput","paused","screenshake","started","laser","setTransform","drawToViewport","qr","gridHovered","gridSelected"],"mappings":"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C,EAAE,GAAG,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,GAAG,CAAC,EAAE,GAAG,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,GAAG,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,GAAG,GAAG,CAAC,CAAC,CAAC,GAAG,GAAG,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,GAAG,CAAC,GAAG,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,GAAG,GAAG,KAAK,CAAC,CAAC,EAAE,GAAG,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,GAAG,CAAC,EAAE,GAAG,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,GAAG,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAA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,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,oFAGF,CACCiB,KAAM,aACNC,KAAM,GACNC,SAAU,EACVnB,OAAQ,CACP,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,oFAGF,CACCiB,KAAM,gBACNC,KAAM,GACNE,MAAO,EACPpB,OAAQ,CACP,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,oFAGF,CACCiB,KAAM,qBACNC,KAAM,GACNC,SAAU,EACVnB,OAAQ,CACP,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,oFAGF,CACCiB,KAAM,WACNC,KAAM,GACNC,SAAU,EACVnB,OAAQ,CACP,kFACA,kFACA,kFACA,kFACA,mFACA,mFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,oFAGF,CACCiB,KAAM,WACNC,KAAM,GACNC,SAAU,EACVnB,OAAQ,CACP,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,kFACA,qFAQCrU,KAAK0V,GACDxQ,QAAQC,IAAIiQ,EAAMC,QAElB,IAAIM,EAAQP,EAAMC,OAAOK,EAAcN,EAAMC,OAAOhM,QACpD,IAAKsM,EAAO,MAAM,IAAIC,MAAM,yBAAyBF,GAKrD,IAEIG,EAFAxB,EAASsB,EAAMtB,OAAO9P,IAAIyN,GAAOA,EAAInC,MAAM,KAC3CiG,EAAa,GAIjBzB,EAASA,EAAO0B,MAAM,EAj2DX,IAm2DX,IAAK,IAAIrT,EAAI,EAAGA,EAn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","file":"app.js","sourcesContent":["(function () {\n    'use strict';\n\n    /**\n     * Constants\n     */\n\n    const TITLE = 'WIZARD WITH A SHOTGUN';\n\n    // The playable area. Note that this is the desired dimensions, but the actual on-screen dimensions\n    // may be larger to maintain aspect ratio (see `Viewport.width` & `Viewport.height`).\n    const GAME_WIDTH = 640;\n    const GAME_HEIGHT = 400;\n\n    // The \"screen area\". This is an ASCII game and so most of the game logic doesn't care about browser\n    // pixels, we care about the ASCII display area (80x25).\n    const SCREEN_WIDTH = 80;\n    const SCREEN_HEIGHT = 25;\n\n    // The size of our on-screen characters (given dimensions above, this is 80 cols by 25 rows).\n    const CHAR_WIDTH = 8;\n    const CHAR_HEIGHT = 16;\n    const CHARSHEET_WIDTH = 16 * CHAR_WIDTH;\n\n    // Game constants, copied from the original game\n    const LEVEL_ROWS = 20;\n    const LEVEL_COLS = 79;\n\n    // Play speeds, expressed as frames per second. Each number is evenly divisible into 1000ms.\n    const PLAY_SPEEDS = [10, 20, 40, 76, 142];\n\n    // Playable levels (see `Levels-gen.js` for the level data)\n    const LEVEL_ORDER = [\n        'Easy Street',\n        'Long Island',\n        'Ghost Town',\n        'Tunnel Vision'\n    ];\n\n    // Score events (note, these are just identifiers for the types of score increases, not\n    // actual score values).\n    const SCORE_ROCK = 0;\n    const SCORE_STATUE = 1;\n    const SCORE_TREASURE = 2;\n\n    /**\n     * Viewport\n     *\n     * Represents the game display (for us, a canvas).\n     */\n    const Viewport = {\n        init() {\n            Viewport.canvas = document.getElementById('canvas');\n            Viewport.ctx = Viewport.canvas.getContext('2d');\n            Viewport.resize(true);\n        },\n\n        // Resize the canvas to give us approximately our desired game display size.\n        //\n        // Rather than attempt to explain it, here's a concrete example:\n        //\n        //     we start with a desired game dimension:   480x270px\n        //          get the actual browser dimensions:  1309x468px\n        //          factor in the display's DPI ratio:  2618x936px\n        //         now calculate the horizontal scale:       5.45x\n        //                     and the vertical scale:       3.46x\n        //            our new offical game scaling is:        5.4x\n        //       and our official viewport dimensions:   484x173px\n        //\n        // This approach emphasizes correct aspect ratio and maintains full-window rendering, at\n        // the potential cost of limiting visibility of the game itself in either the X or Y axis.\n        // If you use this approach, make sure your GUI can \"float\" (otherwise there may be whole\n        // UI elements the player cannot see!).\n        resize(force) {\n            let dpi = window.devicePixelRatio,\n                width = Viewport.canvas.clientWidth,\n                height = Viewport.canvas.clientHeight,\n                dpiWidth = width * dpi,\n                dpiHeight = height * dpi;\n\n            if (\n                force ||\n                Viewport.canvas.width !== dpiWidth ||\n                Viewport.canvas.height !== dpiHeight\n            ) {\n                Viewport.canvas.width = dpiWidth;\n                Viewport.canvas.height = dpiHeight;\n\n                Viewport.scale = ((Math.min(dpiWidth / GAME_WIDTH, dpiHeight / GAME_HEIGHT) * 10) | 0) / 10;\n                Viewport.width = Math.ceil(dpiWidth / Viewport.scale);\n                Viewport.height = Math.ceil(dpiHeight / Viewport.scale);\n                Viewport.center = {\n                    u: (Viewport.width / 2) | 0,\n                    v: (Viewport.height / 2) | 0\n                };\n                Viewport.clientWidth = width;\n                Viewport.clientHeight = height;\n\n                // Note: smoothing flag gets reset on every resize by some browsers, which is why\n                // we do it here.\n                Viewport.ctx.imageSmoothingEnabled = false;\n            }\n\n            // We do this every frame, not just on resize, due to browser sometimes \"forgetting\".\n            //Viewport.canvas.style.cursor = 'none';\n        },\n\n        fillViewportRect() {\n            Viewport.ctx.fillRect(0, 0, Viewport.width, Viewport.height);\n        }\n    };\n\n    function xy2qr(pos) {\n        let qrFraction = {\n            q: (pos.x / 13),\n            r: ((pos.y - pos.x * 6 / 13) / 12)\n        };\n        return qrRounded(qrFraction);\n    }\n\n    function uv2xy(pos) {\n        return {\n            x: pos.u - Viewport.center.u + game.camera.pos.x,\n            y: pos.v - Viewport.center.v + game.camera.pos.y\n        };\n    }\n\n    function qr2qrs(pos) {\n        return { q: pos.q, r: pos.r, s: -pos.q-pos.r };\n    }\n\n    function qrs2qr(pos) {\n        return { q: pos.q, r: pos.r };\n    }\n\n    // When you \"round\" a fractional hexagonal value to an integer one (usually to convert\n    // a mouse click to a hex grid), you can't just `Math.floor()` like you can with standard\n    // square tiles - you'll never get the behavior right on the angled sides of the hexagons.\n    //\n    // To get the behavior you want, you need to convert to cubed coordinates (q,r,s), then\n    // individually round each one and eliminate the one furthest away from your original value.\n    function qrRounded(pos) {\n        let qrsA = qr2qrs(pos),\n            qrsB = {\n                q: Math.round(qrsA.q),\n                r: Math.round(qrsA.r),\n                s: Math.round(qrsA.s)\n            },\n            diffQ = Math.abs(qrsA.q - qrsB.q),\n            diffR = Math.abs(qrsA.r - qrsB.r),\n            diffS = Math.abs(qrsA.s - qrsB.s);\n\n        if (diffQ > diffR && diffQ > diffS) {\n            qrsB.q = -qrsB.r-qrsB.s;\n        } else if (diffR > diffS) {\n            qrsB.r = -qrsB.q-qrsB.s;\n        } else {\n            qrsB.s = -qrsB.q-qrsB.r;\n        }\n\n        return qrs2qr(qrsB);\n    }\n\n    function rgba(r, g, b, a) {\n        return `rgba(${r},${g},${b},${a})`;\n    }\n\n    function createCanvas(width, height) {\n        let canvas = document.createElement('canvas');\n        canvas.width = width;\n        canvas.height = height;\n        let ctx = canvas.getContext('2d');\n        return { canvas, ctx };\n    }\n\n    /**\n     * This module is generated by `gulp buildAssets`.\n     */\n    const SpriteSheet =\n        /* <generated> */\n    { font: [ [ 128, 0, 128, 448 ] ],\n      font2: [ [ 0, 0, 128, 512 ] ],\n      harold: [ [ 128, 448, 19, 12 ] ],\n      base64:\n       'data:image/png;base64,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' };\n    /* </generated> */\n\n    const Terrain = {\n        objects: {},\n\n        init() {\n        }\n    };\n\n    /**\n     * Sprite\n     *\n     * Encapsulates loading sprite slices from the spritesheet, organizing them, and\n     * modifying them or constructing using primitives. To save space, we use some techniques\n     * like storing only a small slice of an image in the spritesheet, then using code\n     * to duplicate it, add some randomness, etc.\n     */\n    const Sprite = {\n        // This is an exception to the rule, loading the spritesheet is a special action that\n        // happens BEFORE everything is initialized.\n        loadSpritesheet(cb) {\n            let image = new Image();\n            image.onload = cb;\n            image.src = SpriteSheet.base64;\n            Sprite.sheet = image;\n        },\n\n        init() {\n            Sprite.harold = [\n                initBasicSprite(SpriteSheet.harold[0], { x: 7, y: 11 })\n            ];\n\n            Sprite.terrain = loadTerrain();\n\n            // Base pixel font and icons (see `Text.init` for additional variations)\n            Sprite.font = initBasicSprite(SpriteSheet.font2[0]);\n\n            return;\n        },\n\n        /**\n         * A small helper that draws a sprite onto a canvas, respecting the anchor point of\n         * the sprite. Note that the canvas should be PRE-TRANSLATED and PRE-ROTATED, if\n         * that's appropriate!\n         */\n        drawSprite(ctx, sprite, u, v) {\n            ctx.drawImage(sprite.img, u - sprite.anchor.x, v - sprite.anchor.y);\n        },\n\n        drawViewportSprite(sprite, pos, rotation) {\n            let { u, v } = this.viewportSprite2uv(\n                sprite,\n                pos\n            );\n            if (rotation) {\n                Viewport.ctx.save();\n                Viewport.ctx.translate(u + sprite.anchor.x, v + sprite.anchor.y);\n                Viewport.ctx.rotate(rotation);\n                Viewport.ctx.drawImage(\n                    sprite.img,\n                    -sprite.anchor.x,\n                    -sprite.anchor.y\n                );\n                Viewport.ctx.restore();\n            } else {\n                Viewport.ctx.drawImage(sprite.img, u, v);\n            }\n        },\n\n        viewportSprite2uv(sprite, pos) {\n            return {\n                u: pos.x - sprite.anchor.x - game.camera.pos.x + Viewport.center.u,\n                v: pos.y - sprite.anchor.y - game.camera.pos.y + Viewport.center.v\n            };\n        }\n    };\n\n    // Sprite utility functions\n\n    function initBasicSprite(data, anchor) {\n        return initDynamicSprite(loadCacheSlice(...data), anchor);\n    }\n\n    function initDynamicSprite(source, anchor) {\n        let w = source.width,\n            h = source.height;\n\n        return {\n            img: source,\n            // Hack! Using a flat `.map(initBasicSprite)` is actually going to pass the\n            // element INDEX as second argument, resulting in \"anchor=1\". The right solution\n            // here is \"typeof anchor === 'object' ?\", but to save bytes I avoid using\n            // the typeof and instanceof keywords anywhere in the codebase. Hence,\n            // \"anchor && anchor.x\".\n            anchor: (anchor && anchor.x) ? anchor : { x: (w / 2) | 0, y: (h / 2) | 0 }\n        };\n    }\n\n    function loadCacheSlice(x, y, w, h) {\n        const source = Sprite.sheet;\n        const sliceCanvas = createCanvas(w, h);\n        sliceCanvas.ctx.drawImage(source, x, y, w, h, 0, 0, w, h);\n        return sliceCanvas.canvas;\n    }\n\n    function processTerrain(key) {\n        let source = loadCacheSlice(...SpriteSheet[key][0]);\n        let canvas = createCanvas(source.width, source.height);\n        canvas.ctx.drawImage(source, 0, 0);\n        let im = canvas.ctx.getImageData(0, 0, source.width, source.height);\n\n        let floors = [];\n\n        for (let y = 0; y < source.height; y++) {\n            let min = Infinity, max = -Infinity;\n            for (let x = 0; x < source.width; x++) {\n                if (im.data[(y * source.width + x) * 4] === 128) {\n                    console.log('DOGGIT');\n                    min = Math.min(min, x);\n                    max = Math.max(max, x);\n                }\n            }\n            if (min <= max) {\n                floors.push([{ x: min, y }, { x: max, y }]);\n            }\n        }\n\n        canvas.ctx.globalCompositeOperation = 'source-atop';\n        canvas.ctx.fillStyle = rgba(0, 0, 0, 1);\n        canvas.ctx.fillRect(0, 0, source.width, source.height);\n\n        return { sprite: canvas.canvas, floors };\n    }\n\n    function loadTerrain() {\n        let keys = Object.keys(SpriteSheet).filter(key => key.startsWith('t_'));\n        return Object.fromEntries(\n            keys.map(key => {\n                let parsed = processTerrain(key);\n                parsed.sprite = initDynamicSprite(parsed.sprite, { x: 0, y: 0 });\n\n                Terrain.objects[key] = parsed;\n                return [key, parsed.sprite];\n            })\n        );\n    }\n\n    /**\n     * KeyboardAdapter\n     *\n     * Maps keyboard inputs to game inputs.\n     */\n    const KeyboardAdapter = {\n        init() {\n            KeyboardAdapter.map = {\n                KeyW:        Input.Action.UP,\n                KeyA:        Input.Action.LEFT,\n                KeyS:        Input.Action.DOWN,\n                KeyD:        Input.Action.RIGHT,\n                ArrowUp:     Input.Action.UP,\n                ArrowLeft:   Input.Action.LEFT,\n                ArrowDown:   Input.Action.DOWN,\n                ArrowRight:  Input.Action.RIGHT,\n                Space:       Input.Action.JUMP,\n                Escape:      Input.Action.MENU\n            };\n\n            // For keyboard, we support 8-point movement (S, E, SE, etc.)\n            KeyboardAdapter.arrowDirections = [\n                { x:  0, y:  0, m: 0 },\n                { x:  0, y: -1, m: 1 },\n                { x:  0, y:  1, m: 1 },\n                { x:  0, y:  0, m: 0 },\n                { x: -1, y:  0, m: 1 },\n                { x: -1, y: -1, m: 1 },\n                { x: -1, y:  1, m: 1 },\n                { x: -1, y:  0, m: 1 },\n                { x:  1, y:  0, m: 1 },\n                { x:  1, y: -1, m: 1 },\n                { x:  1, y:  1, m: 1 },\n                { x:  1, y:  0, m: 1 },\n                { x:  0, y:  0, m: 0 },\n                { x:  0, y: -1, m: 1 },\n                { x:  0, y:  1, m: 1 },\n                { x:  0, y:  0, m: 0 }\n            ];\n\n            KeyboardAdapter.held = [];\n\n            window.addEventListener('keydown', event => {\n                let k = KeyboardAdapter.map[event.code];\n                // Debugging - key presses\n                // console.log(event.key, event.keyCode, event.code, k);\n                //console.log(event.code);\n                //console.log(event);\n                if (k) {\n                    KeyboardAdapter.held[k] = true;\n                }\n                Input.buffer.push({ key: event.key, at: new Date().getTime() });\n            });\n\n            window.addEventListener('keyup', event => {\n                let k = KeyboardAdapter.map[event.code];\n                if (k) {\n                    KeyboardAdapter.held[k] = false;\n                }\n            });\n\n            KeyboardAdapter.reset();\n        },\n\n        update() {\n            // For keyboards, we want to convert the state of the various arrow keys being held down\n            // into a directional vector. We use the browser's event to handle the held state of\n            // the other action buttons, so we don't need to process them here.\n            let state =\n                (KeyboardAdapter.held[Input.Action.UP] ? 1 : 0) +\n                (KeyboardAdapter.held[Input.Action.DOWN] ? 2 : 0) +\n                (KeyboardAdapter.held[Input.Action.LEFT] ? 4 : 0) +\n                (KeyboardAdapter.held[Input.Action.RIGHT] ? 8 : 0);\n\n            KeyboardAdapter.direction = KeyboardAdapter.arrowDirections[state];\n        },\n\n        reset() {\n            KeyboardAdapter.direction = KeyboardAdapter.arrowDirections[0];\n            for (let action of Object.values(Input.Action)) {\n                KeyboardAdapter.held[action] = false;\n            }\n        }\n    };\n\n    // zzfx() - the universal entry point -- returns a AudioBufferSourceNode\n    const zzfx=(...t)=>zzfxP(zzfxG(...t));\n\n    // zzfxP() - the sound player -- returns a AudioBufferSourceNode\n    const zzfxP=(...t)=>{let e=zzfxX.createBufferSource(),f=zzfxX.createBuffer(t.length,t[0].length,zzfxR);t.map((d,i)=>f.getChannelData(i).set(d)),e.buffer=f,e.connect(zzfx.destination_),e.start();return e};\n\n    // zzfxG() - the sound generator -- returns an array of sample data\n    const zzfxG=(q=1,k=.05,c=220,e=0,t=0,u=.1,r=0,F=1,v=0,z=0,w=0,A=0,l=0,B=0,x=0,G=0,d=0,y=1,m=0,C=0)=>{let b=2*Math.PI,H=v*=500*b/zzfxR**2,I=(0<x?1:-1)*b/4,D=c*=(1+2*k*Math.random()-k)*b/zzfxR,Z=[],g=0,E=0,a=0,n=1,J=0,K=0,f=0,p,h;e=99+zzfxR*e;m*=zzfxR;t*=zzfxR;u*=zzfxR;d*=zzfxR;z*=500*b/zzfxR**3;x*=b/zzfxR;w*=b/zzfxR;A*=zzfxR;l=zzfxR*l|0;for(h=e+m+t+u+d|0;a<h;Z[a++]=f)++K%(100*G|0)||(f=r?1<r?2<r?3<r?Math.sin((g%b)**3):Math.max(Math.min(Math.tan(g),1),-1):1-(2*g/b%2+2)%2:1-4*Math.abs(Math.round(g/b)-g/b):Math.sin(g),f=(l?1-C+C*Math.sin(2*Math.PI*a/l):1)*(0<f?1:-1)*Math.abs(f)**F*q*zzfxV*(a<e?a/e:a<e+m?1-(a-e)/m*(1-y):a<e+m+t?y:a<h-d?(h-a-d)/u*y:0),f=d?f/2+(d>a?0:(a<h-d?1:(h-a)/d)*Z[a-d|0]/2):f),p=(c+=v+=z)*Math.sin(E*x-I),g+=p-p*B*(1-1E9*(Math.sin(a)+1)%2),E+=p-p*B*(1-1E9*(Math.sin(a)**2+1)%2),n&&++n>A&&(c+=w,D+=w,n=0),!l||++J%l||(c=D,v=H,n=n||1);return Z};\n\n    // zzfxV - global volume\n    const zzfxV=.3;\n\n    // zzfxR - global sample rate\n    const zzfxR=44100;\n\n    // zzfxX - the common audio context\n    const zzfxX=new(top.AudioContext||webkitAudioContext);\n\n    // destination for zzfx and zzfxm sounds\n    zzfx.destination_ = zzfxX.destination;\n\n    /**\n     * ZzFX Music Renderer v2.0.2 by Keith Clark\n     */\n\n    /**\n     * @typedef Channel\n     * @type {Array.<Number>}\n     * @property {Number} 0 - Channel instrument\n     * @property {Number} 1 - Channel panning (-1 to +1)\n     * @property {Number} 2 - Note\n     */\n\n    /**\n     * @typedef Pattern\n     * @type {Array.<Channel>}\n     */\n\n    /**\n     * @typedef Instrument\n     * @type {Array.<Number>} ZzFX sound parameters\n     */\n\n    /**\n     * Generate a song\n     *\n     * @param {Array.<Instrument>} instruments - Array of ZzFX sound paramaters.\n     * @param {Array.<Pattern>} patterns - Array of pattern data.\n     * @param {Array.<Number>} sequence - Array of pattern indexes.\n     * @param {Number} [speed=125] - Playback speed of the song (in BPM).\n     * @returns {Array.<Array.<Number>>} Left and right channel sample data.\n     */\n\n    const zzfxM = (instruments, patterns, sequence, BPM = 125) => {\n        let instrumentParameters,\n            i,\n            j,\n            k,\n            note,\n            sample,\n            patternChannel,\n            notFirstBeat,\n            stop,\n            instrument,\n            pitch,\n            attenuation,\n            outSampleOffset,\n            sampleOffset,\n            nextSampleOffset,\n            sampleBuffer = [],\n            leftChannelBuffer = [],\n            rightChannelBuffer = [],\n            channelIndex = 0,\n            panning,\n            hasMore = 1,\n            sampleCache = {},\n            beatLength = ((zzfxR / BPM) * 60) >> 2;\n\n        // for each channel in order until there are no more\n        for (; hasMore; channelIndex++) {\n            // reset current values\n            sampleBuffer = [(hasMore = notFirstBeat = pitch = outSampleOffset = 0)];\n\n            // for each pattern in sequence\n            sequence.map((patternIndex, sequenceIndex) => {\n                // get pattern for current channel, use empty 1 note pattern if none found\n                patternChannel = patterns[patternIndex][channelIndex] || [0, 0, 0];\n\n                // check if there are more channels\n                hasMore |= !!patterns[patternIndex][channelIndex];\n\n                // get next offset, use the length of first channel\n                nextSampleOffset =\n                    outSampleOffset +\n                    (patterns[patternIndex][0].length - 2 - !notFirstBeat) *\n                        beatLength;\n\n                // for each beat in pattern, plus one extra if end of sequence\n                for (\n                    i = 2, k = outSampleOffset;\n                    i <\n                    patternChannel.length + (sequenceIndex == sequence.length - 1);\n                    notFirstBeat = ++i\n                ) {\n                    // <channel-note>\n                    note = patternChannel[i];\n\n                    // stop if different instrument or new note\n                    stop = (instrument != (patternChannel[0] || 0)) | note | 0;\n\n                    // fill buffer with samples for previous beat, most cpu intensive part\n                    for (\n                        j = 0;\n                        j < beatLength && notFirstBeat;\n                        // fade off attenuation at end of beat if stopping note, prevents clicking\n                        j++ > beatLength - 99 && stop\n                            ? (attenuation += (attenuation < 1) / 99)\n                            : 0\n                    ) {\n                        // copy sample to stereo buffers with panning\n                        sample =\n                            ((1 - attenuation) * sampleBuffer[sampleOffset++]) /\n                                2 || 0;\n                        leftChannelBuffer[k] =\n                            (leftChannelBuffer[k] || 0) + sample * panning - sample;\n                        rightChannelBuffer[k] =\n                            (rightChannelBuffer[k++] || 0) +\n                            sample * panning +\n                            sample;\n                    }\n\n                    // set up for next note\n                    if (note) {\n                        // set attenuation\n                        attenuation = note % 1;\n                        panning = patternChannel[1] || 0;\n                        if ((note |= 0)) {\n                            // get cached sample\n                            sampleBuffer = sampleCache[\n                                [\n                                    (instrument =\n                                        patternChannel[(sampleOffset = 0)] || 0),\n                                    note\n                                ]\n                            ] =\n                                sampleCache[[instrument, note]] ||\n                                // add sample to cache\n                                ((instrumentParameters = [\n                                    ...instruments[instrument]\n                                ]),\n                                (instrumentParameters[2] *=\n                                    2 ** ((note - 12) / 12)),\n                                zzfxG(...instrumentParameters));\n                        }\n                    }\n                }\n\n                // update the sample offset\n                outSampleOffset = nextSampleOffset;\n            });\n        }\n\n        return [leftChannelBuffer, rightChannelBuffer];\n    };\n\n    const ObliqueMystique = [[[1.3,0,23,,,.2,3,5],[1.5,0,4e3,,,.03,2,1.25,,,,,.02,6.8,-.3,,.5],[.7,0,2100,,,.2,3,3,,,-400,,,2],[,0,655,,,.11,2,1.65,,,,,,3.8,-.1,.1]],[[[,-.5,13,,,,,,13,,,,,,13,,,,,,13,,,,,,13,,,,14,,,,13,,,,,,13,,,,,,13,,,,,,13,,,,,,13,,,,14,,,,],[1,.3,13,,13,,13,,13,,,,13,,13,,13,,13,,13,,,,13,,13,,13,,13,,13,,13,,13,,13,,13,,,,13,,13,,13,,13,,13,,,,13,,13,,13,,13,,13,,],[2,1,,,,,,,,,13,,,,,,,,,,,,13,,,,,,,,,,,,,,,,,,,,13,,,,,,,,,,,,13,,,,,,,,,,,,],[,.6,,,,,13,,18,,19,,,,,,,,19,,18,,,,16,,,,13,,,,,,,,,,13,,18,,19,,,,,,,,18,19,18,,,,13,14,13,,16,,18,,19,,],[3,-1,,,13,,,,,,,,,,,,13,,,,,,,,,,,,,,,,,,,,13,,,,,,,,,,,,13,,,,,,,,,,,,,,13,13,13,13]],[[,-.5,13,,,,,,13,,,,,,13,,,,,,13,,,,,,13,,,,14,,,,13,,,,,,13,,,,,,13,,,,,,13,,,,,,13,,,,14,,,,],[1,.3,13,,13,,13,,13,,,,13,,13,,13,,13,,13,,,,13,,13,,13,,13,,13,,13,,13,,13,,13,,,,13,,13,,13,,13,,13,,,,13,,13,,13,,13,,13,,],[2,1,,,,,,,,,13,,,,,,,,,,,,13,,,,,,,,,,,,,,,,,,,,13,,,,,,,,,,,,13,,,,,,,,,,,,]]],[1,1,0,0,0,0,1,0],,];\n\n    const Audio = {\n        init() {\n            Audio.readyToPlay = false;\n\n            Audio.ctx = zzfxX;\n            Audio.gain_ = Audio.ctx.createGain();\n            Audio.gain_.connect(Audio.ctx.destination);\n            zzfx.destination_ = Audio.gain_;\n\n            Audio.shotgun = [,0.01,140,0.01,0.02,0.45,4,2.42,0.1,-0.1,,,,1.2,,0.3,0.04,0.8,0.02];\n            Audio.page = [,,1233,,.01,.2,1,1.43,,,539,.1,,,,,,.51,.03,.01];\n            Audio.shellReload = [,,68,0.01,,0.14,1,1.53,7.5,0.1,50,0.02,-0.01,-0.2,0.1,0.2,,0.47,0.01];\n            Audio.damage = [,,391,,.19,.01,2,.54,-4,20,,,,,,,.02,.9];\n            Audio.alarm = [,,970,.12,.25,.35,,.39,8.1,,10,.1,.2,,.1,,,.6,.09,.13];\n            // [,,961,.05,.06,1.17,1,4.67,.8,,,,,.8,-0.8,.1,.49,.62,.09];\n            Audio.victory = [,,454,.06,.86,.71,2,.63,-0.7,1.7,-83,.09,.27,.3,.2,,.18,.95,.02,.02];\n            Audio.song = zzfxM(...ObliqueMystique);\n\n            // Save our background music in os13k, for fun!\n            localStorage[`OS13kMusic,${TITLE} - Oblique Mystique`] = JSON.stringify(ObliqueMystique);\n        },\n\n        update() {\n            if (!Audio.readyToPlay) return;\n\n            if (!Audio.musicPlaying) {\n                //Audio.bgmusicnode = zzfxP(...Audio.song);\n                //Audio.bgmusicnode.loop = true;\n                Audio.musicPlaying = true;\n            }\n        },\n\n        play(sound) {\n            if (!Audio.readyToPlay) return;\n            zzfx(...sound);\n        },\n\n        // It's important we do pausing and unpausing as specific events and not in general update(),\n        // because update() is triggered by the animation frame trigger which does not run if the\n        // page is not visible. (So, if you want the music to fade in the background, for example,\n        // that's not helpful if it won't work because you aren't looking at the page!)\n\n        pause() {\n            Audio.gain_.gain.linearRampToValueAtTime(0, Audio.ctx.currentTime + 1);\n        },\n\n        unpause() {\n            Audio.gain_.gain.linearRampToValueAtTime(1, Audio.ctx.currentTime + 1);\n        }\n    };\n\n    /**\n     * MouseAdapter\n     *\n     * Maps mouse inputs to game inputs.\n     */\n    const MouseAdapter = {\n        init() {\n            this.map = [];\n            this.map[0] = Input.Action.ATTACK; // LMB\n            this.map[2] = Input.Action.RELOAD; // RMB\n\n            this.held = [];\n\n            window.addEventListener('mousemove', event => {\n                if (!this.pointer) this.pointer = {};\n                this.pointer.u = ((event.clientX * Viewport.width) / Viewport.clientWidth) | 0;\n                this.pointer.v = ((event.clientY * Viewport.height) / Viewport.clientHeight) | 0;\n            });\n\n            window.addEventListener('mouseout', () => {\n                this.pointer = undefined;\n            });\n\n            window.addEventListener('mousedown', event => {\n                let k = this.map[event.button];\n                if (k) this.held[k] = true;\n\n                // Hack to ensure we initialize audio after user interacts with game\n                Audio.readyToPlay = true;\n            });\n\n            window.addEventListener('mouseup', event => {\n                let k = this.map[event.button];\n                if (k) this.held[k] = false;\n            });\n\n            window.addEventListener('click', event => {\n                event.preventDefault();\n            });\n\n            window.addEventListener('contextmenu', event => {\n                let k = this.map[event.button];\n                if (k) this.held[k] = true;\n                this.releaseRMBTick = 2;\n                event.preventDefault();\n            });\n\n            MouseAdapter.reset();\n        },\n\n        update() {\n            // Hacks: ideally we could use mousedown and mouseup for all clicks and preventDefault to\n            // avoid opening the browser's context menu. This hasn't worked for me so far when clicking\n            // on a canvas, so I need to use the context menu event to capture a right mouse click instead.\n            //\n            // We fake a down/up for RMB clicks, which means we can't determine how long the RMB is held\n            // (but luckily we don't need to for this game).\n            if (this.releaseRMBTick) {\n                this.releaseRMBTick--;\n                if (this.releaseRMBTick === 0) {\n                    this.held[Input.Action.RELOAD] = false;\n                }\n            }\n        },\n\n        reset() {\n            this.pointer = undefined;\n            for (let action of Object.values(Input.Action)) {\n                this.held[action] = false;\n            }\n        }\n    };\n\n    //import { GamepadAdapter } from './GamepadAdapter';\n    //import { NormalVector } from './Geometry';\n\n    /**\n     * This is our abstract game input handler.\n     *\n     * Each frame, we'll collect input data from all of our supported input adapters,\n     * and turn it into game input. This game input can then be used by the game\n     * update for the frame.\n     *\n     * The input adapters give us data like \"key X pressed\", or \"right mouse button\n     * clicked\", or \"button B\" pressed, and these are translated into a game input\n     * like \"dodge\".\n     */\n    const Input = {\n        // Game Inputs\n        //\n        // Note that moving the player around is actually not considered an action; it's\n        // a separate non-action input called \"direction\". It just so happens that on\n        // keyboard, for example, pressing the \"down arrow\" key is considered both a\n        // press of the in-game DOWN action and a directional input. It's up to the input\n        // consumer to decide which input is relevant (if any). For example, on a menu,\n        // we may consume the DOWN/UP actions to navigate the menu, but ignore directional\n        // inputs.\n        //\n        Action: {\n            UP:     31,\n            DOWN:   32,\n            LEFT:   33,\n            RIGHT:  34,\n            JUMP:   35,\n            ATTACK: 21,\n            RELOAD: 30,\n            MENU: 96,\n            MUTE: 97,\n            FREEZE: 98\n        },\n\n        init() {\n            // A vector representing the direction the user is pressing/facing,\n            // separate from pressing and releasing inputs. Treating \"direction\"\n            // separately makes it easier to handle gamepad sticks.\n            this.direction = { x: 0, y: 0, m: 0 };\n\n            // \"Pressed\" means an input was pressed THIS FRAME.\n            this.pressed = {};\n\n            // \"Released\" means an input was released THIS FRAME.\n            this.released = {};\n\n            // \"Held\" means an input is held down. The input was \"Pressed\" either\n            // this frame or in a past frame, and has not been \"Released\" yet.\n            this.held = {};\n\n            // How many frames was this input held down by the player. If [held]\n            // is false, it represents how long the input was last held down.\n            this.framesHeld = {};\n\n            this.buffer = [];\n\n            KeyboardAdapter.init();\n            MouseAdapter.init();\n            //GamepadAdapter.init();\n        },\n\n        update() {\n            // We could have some kind of \"input adapter toggle\", but it's easier to just treat all inputs\n            // as valid -- if you're pressing the \"attack\" button on either gamepad or keyboard, then you're\n            // attacking. For directional input, we instead check whether there's movement on the thumbstick,\n            // and we use it if there is -- otherwise we try to extract movement from the keyboard instead.\n\n            KeyboardAdapter.update();\n            MouseAdapter.update();\n            //GamepadAdapter.update();\n\n            for (let action of Object.values(Input.Action)) {\n                let held = MouseAdapter.held[action] || KeyboardAdapter.held[action];\n                //let held = GamepadAdapter.held[action] || KeyboardAdapter.held[action];\n                this.pressed[action] = !this.held[action] && held;\n                this.released[action] = this.held[action] && !held;\n\n                if (this.pressed[action]) {\n                    this.framesHeld[action] = 1;\n                } else if (this.held[action] && held) {\n                    this.framesHeld[action]++;\n                }\n\n                this.held[action] = held;\n            }\n\n            this.pointer = MouseAdapter.pointer;\n            this.direction = KeyboardAdapter.direction;\n            //this.direction = this.gamepad.direction.m > 0 ? this.gamepad.direction : this.keyboard.direction;\n\n            let now = new Date().getTime();\n            this.buffer = this.buffer.filter(entry => entry.at > now - 3000);\n        },\n\n        lastKeyPressed() {\n            return this.buffer.length > 0 ? this.buffer[this.buffer.length - 1].key : '';\n        },\n\n        consume() {\n            this.buffer = [];\n        },\n\n        onDown(action) {},\n        onUp(action) {},\n    };\n\n    // In our character sheet, chars 0x00-0x7F are standard ASCII, below that we put whatever\n    // characters are convenient for us. Here we can choose to map unicode characters to positions\n    // 0x80+ in the charsheet, making it easy for us to render things like special characters,\n    // box drawing characters, etc.\n    const SUPPORTED_UNICODE_CHARS = [\n        '',\n        '',\n        ''\n    ].join('');\n\n    const UNICODE_CHAR_MAP = SUPPORTED_UNICODE_CHARS.split('').reduce((map, char, idx) => {\n        map[char] = 0x80 + idx;\n        return map;\n    }, {});\n\n    /**\n     * Text\n     *\n     * Utilities for drawing text using in-game pixel font.\n     */\n    const Text = {\n        init() {\n            Text.white = Sprite.font.img;\n\n            Text.black = recolor(Text.white, rgba(0, 0, 0, 1));\n            Text.black_shadow = recolor(Text.white, rgba(90, 20, 90, 0.15));\n            Text.blue = recolor(Text.white, rgba(200, 40, 220, 1));\n            Text.blue_shadow = recolor(Text.white, rgba(240, 50, 200, 0.2));\n            Text.shadow = recolor(Text.white, rgba(240, 240, 255, 0.25));\n            Text.red = recolor(Text.white, rgba(240, 50, 50, 1));\n\n            Text.terminal = recolor(Text.white, rgba(51, 255, 0, 1));\n            Text.terminal_shadow = recolor(Text.white, rgba(255, 255, 255, 0.3));\n\n            Text.terminal = recolor(Text.white, rgba(51, 255, 0, 0.9));\n            Text.terminal_shadow = undefined;\n\n            Text['#ead4aa'] = recolor(Text.white, '#ead4aa');\n            Text['#fee761'] = recolor(Text.white, '#fee761');\n            Text['#ff0044'] = recolor(Text.white, '#ff0044');\n        },\n\n        drawText(ctx, text, u, v, scale = 1, font = Text.white, shadow) {\n            if (Array.isArray(text)) {\n                for (let block of text) {\n                    Text.drawText(ctx, block.text, u + block.u * scale, v + block.v * scale, scale, font, shadow);\n                }\n                return;\n            }\n\n            for (let idx = 0; idx < text.length; idx++) {\n                let c = UNICODE_CHAR_MAP[text[idx]] || text.charCodeAt(idx);\n                let k = (c - 0) * (CHAR_WIDTH);\n                if (shadow) {\n                    ctx.drawImage(\n                        shadow,\n                        k % CHARSHEET_WIDTH,\n                        Math.floor(k / CHARSHEET_WIDTH) * CHAR_HEIGHT,\n                        CHAR_WIDTH,\n                        CHAR_HEIGHT,\n                        u + 1,\n                        v,\n                        CHAR_WIDTH * scale,\n                        CHAR_HEIGHT * scale\n                    );\n                }\n                ctx.drawImage(\n                    font,\n                    k % CHARSHEET_WIDTH,\n                    Math.floor(k / CHARSHEET_WIDTH) * CHAR_HEIGHT,\n                    CHAR_WIDTH,\n                    CHAR_HEIGHT,\n                    u,\n                    v,\n                    CHAR_WIDTH * scale,\n                    CHAR_HEIGHT * scale\n                );\n                u += CHAR_WIDTH * scale;\n            }\n        },\n\n        /*\n        drawRightText(ctx, text, u, v, scale = 1, font = Text.white, shadow) {\n            u -= Text.measureWidth(text, scale);\n            Text.drawText(ctx, text, u, v, scale, font, shadow);\n        },\n        */\n\n        measureWidth(text, scale = 1) {\n            return text.split('').reduce((sum, c) => sum + CHAR_WIDTH, 0) * scale;\n        },\n\n        splitParagraph(text, w, h) {\n            let cu = 0, cv = 0;\n            let next = () => ({ text: '', u: cu, v: cv });\n            let wip = next();\n            let list = [];\n\n            for (let c of text.split('')) {\n                let cWidth = Text.measureWidth(c, 1);\n                if (c === '\\n' || cu + cWidth > w) {\n                    let saved = '';\n                    if (c !== '\\n' && c !== ' ') {\n                        let space = wip.text.split(' ');\n                        if (space.length > 1) {\n                            saved = space.pop();\n                            wip.text = space.join(' ');\n                        }\n                    }\n                    if (wip.text.length > 0) list.push(wip);\n                    cu = 0;\n                    cv += (CHAR_HEIGHT);\n                    wip = next();\n                    if (saved.length > 0) {\n                        wip.text = saved;\n                        cu += Text.measureWidth(wip.text, 1);\n                    }\n                } else {\n                    cu += cWidth;\n                }\n                if (c !== '\\n') {\n                    wip.text = wip.text + c;\n                }\n            }\n\n            if (wip.text.length > 0) list.push(wip);\n\n            return list.map(line => ({\n                ...line,\n                w: Text.measureWidth(line.text, 1),\n                h: CHAR_HEIGHT\n            }));\n        },\n\n        drawTextColRow(text, col, row) {\n            Text.drawText(Viewport.ctx, Text.splitParagraph(text, Viewport.width), col * CHAR_WIDTH, row * CHAR_HEIGHT, 1, Text.terminal, Text.terminal_shadow);\n        }\n    };\n\n    // Text utility functions\n\n    function recolor(font, color) {\n        let canvas = createCanvas(font.width, font.height);\n        canvas.ctx.fillStyle = color;\n        canvas.ctx.fillRect(0, 0, font.width, font.height);\n        canvas.ctx.globalCompositeOperation = 'destination-in';\n        canvas.ctx.drawImage(font, 0, 0);\n        return canvas.canvas;\n    }\n\n    /**\n     * Hud\n     *\n     * Health bars, ammo, etc.\n     */\n    const Hud = {\n        init() {\n    //        Hud.tooltipCanvas = new Canvas(GAME_WIDTH, GAME_HEIGHT);\n        },\n\n        draw() {\n            return;\n        },\n    /*\n        drawPageArrow() {\n            let page = Hud.closestPage();\n            if (page) {\n                let vector = vectorBetween(game.player.pos, page.pos);\n                let angle = vector2angle(vector);\n                vector.m = clamp(vector.m / 2, 16, Viewport.height / 2 - 5);\n                if (vector.m > 64) {\n                    let xy = vectorAdd(game.player.pos, vector);\n                    let a = Math.sin(game.frame / 60)\n                    Viewport.ctx.globalAlpha = Math.sin(game.frame / 20) * 0.2 + 0.8;\n                    Sprite.drawViewportSprite(Sprite.page[2], xy, angle + R90);\n                    Viewport.ctx.globalAlpha = 1;\n                }\n            }\n        },\n\n        closestPage() {\n            let pages = game.entities.filter(entity => entity.page);\n            let pos = game.player.pos;\n            pages.sort((a, b) => {\n                let dist = ((a.pos.x - pos.x) ** 2 + (a.pos.y - pos.y) ** 2) - ((b.pos.x - pos.x) ** 2 + (b.pos.y - pos.y) ** 2);\n                return dist;\n            });\n            return pages[0];\n        },\n\n        drawBuildingHover(uv) {\n            let anchor = { ...uv };\n\n            if (anchor.u + 100 > Viewport.width) anchor.u -= 100;\n            if (anchor.v > 80 + 10) anchor.v -= 80;\n\n            Viewport.ctx.fillStyle = 'rgba(30, 30, 30, 0.9)';\n            Viewport.ctx.fillRect(anchor.u, anchor.v, 100, 80);\n\n            Viewport.ctx.strokeStyle = 'rgba(95, 205, 228, 0.9)';\n            Viewport.ctx.strokeRect(anchor.u, anchor.v, 100, 80);\n\n            Text.drawText(\n                Viewport.ctx,\n                Text.splitParagraph(\n                    'SNIPER TOWER\\n\\n' +\n                    '- STRONG VS GROUND\\n' +\n                    '- WEAK VS AIR\\n',\n                    100\n                ),\n                anchor.u + 4, anchor.v + 4,\n                1,\n                Text.white,\n                Text.shadow\n            );\n\n            // random lightning effect!\n            //Hud.drawLightning(30, 60, 120, 90);\n            Hud.drawLightning(30, 60, uv.u, uv.v);\n        },\n\n        drawTooltip(uv, body, cost) {\n            Hud.tooltipCanvas.ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);\n\n            let lines = Text.splitParagraph(body, 100, 0);\n            let w = Math.max(...lines.map(line => line.w)), h = lines[lines.length - 1].v + lines[lines.length - 1].h;\n            let u = 3, v = 3;\n\n            if (cost) {\n                cost = `${cost.ore || 0}@   ${cost.crystal || 0}$`;\n                w = Math.max(w, Text.measureWidth(cost), 75);\n                h += 10;\n            }\n\n            Hud.tooltipCanvas.ctx.fillStyle = '#ead4aa';\n            Hud.tooltipCanvas.ctx.fillRect(0, 0, w + 6, h + 6);\n\n            Hud.tooltipCanvas.ctx.fillStyle = '#262b44';\n            Hud.tooltipCanvas.ctx.fillRect(1, 1, w + 4, h + 4);\n\n            Hud.tooltipCanvas.ctx.clearRect(0, h + 5, 1, 1);\n\n            if (cost) {\n                Text.drawText(Hud.tooltipCanvas.ctx, cost, u + w - Text.measureWidth(cost), v, 1, Text['#fee761'], Text.shadow);\n                v += 10;\n            }\n\n            Text.drawText(Hud.tooltipCanvas.ctx, lines, u, v, 1, Text['#ead4aa'], Text.shadow);\n\n            Viewport.ctx.globalAlpha = 0.9;\n            Viewport.ctx.drawImage(Hud.tooltipCanvas.canvas, uv.u, uv.v - h - 6);\n            Viewport.ctx.globalAlpha = 1;\n\n            /*\n\n            let textsize = Text.drawParagraph(\n                Hud.tooltipCanvas.ctx,\n                body,\n                2, 2,\n                100, 0,\n                1,\n                Text.white,\n                Text.shadow\n            );\n\n            let anchor = { ...uv };\n\n            if (anchor.u + 100 > Viewport.width) anchor.u -= 100;\n            if (anchor.v > 80 + 10) anchor.v -= 80;\n\n            Viewport.ctx.fillStyle = 'rgba(30, 30, 30, 0.9)';\n            Viewport.ctx.fillRect(anchor.u, anchor.v, 100, 80);\n\n            Viewport.ctx.strokeStyle = 'rgba(95, 205, 228, 0.9)';\n            Viewport.ctx.strokeRect(anchor.u, anchor.v, 100, 80);\n\n            Text.drawParagraph(\n                Viewport.ctx,\n                'SNIPER TOWER\\n\\n' +\n                '- STRONG VS GROUND\\n' +\n                '- WEAK VS AIR\\n',\n                anchor.u + 4, anchor.v + 4,\n                100 - 8, 80,\n                1,\n                Text.white,\n                Text.shadow\n            );\n\n            // random lightning effect!\n            //Hud.drawLightning(30, 60, 120, 90);\n            Hud.drawLightning(30, 60, uv.u, uv.v);\n\n        },\n\n        drawLightning2(x1, y1, x2, y2) {\n            let sections = 10;\n            let vector = vectorBetween({ x: x1, y: y1 }, { x: x2, y: y2 });\n\n            Viewport.ctx.strokeStyle = 'rgba(95, 205, 228, 1)';\n            Viewport.ctx.strokeStyle = 'rgba(190, 235, 250, 1)';\n            Viewport.ctx.lineWidth = 1;\n\n            Viewport.ctx.beginPath();\n            Viewport.ctx.moveTo(x1, y1);\n            for (let i = 1; i <= sections; i++) {\n                let x = x1 + (x2 - x1) * i / sections;\n                let y = y1 + (y2 - y1) * i / sections;\n                if (i < sections) {\n                    //x += (Math.random() * (i + 3) - (i + 3) / 2) | 0;\n                    //y += (Math.random() * (i + 3) - (i + 3) / 2) | 0;\n                    let offset = Math.random() * 20 - 10;\n                    if (i > 4 && i < 7) offset *= 1.5;\n                    x += vector.y * offset;\n                    y -= vector.x * offset;\n                }\n                Viewport.ctx.lineTo(x, y);\n            }\n            Viewport.ctx.stroke();\n        },\n\n        drawLightning3(x1, y1, x2, y2) {\n            if (!this.lightningOffsets) {\n                this.lightningOffsets = Array(8).fill().map((slot, index) => ({\n                    pos: (index + 1) * 10,\n                    value: Math.random() * 2 - 1\n                }));\n                console.log(this.lightningOffsets);\n            }\n\n            let vector = vectorBetween({ x: x1, y: y1 }, { x: x2, y: y2 });\n\n            Viewport.ctx.strokeStyle = 'rgba(95, 205, 228, 1)';\n            Viewport.ctx.strokeStyle = 'rgba(190, 235, 250, 1)';\n            Viewport.ctx.lineWidth = 1;\n\n            Viewport.ctx.beginPath();\n            Viewport.ctx.moveTo(x1, y1);\n            for (let offset of this.lightningOffsets) {\n                // First get the (x,y) along the direct line to the target\n                let x = x1 + vector.x * vector.m * offset.pos / 100;\n                let y = y1 + vector.y * vector.m * offset.pos / 100;\n\n                // Now we \"offset\" it (perpendicular to the direct line) by the specified value\n                x += vector.y * offset.value * 10;\n                y -= vector.x * offset.value * 10;\n\n                Viewport.ctx.lineTo(x, y);\n            }\n            Viewport.ctx.lineTo(x2, y2);\n            Viewport.ctx.stroke();\n\n            for (let offset of this.lightningOffsets) {\n                offset.pos += 5;\n            }\n            if (this.lightningOffsets[0].pos > 10) {\n                this.lightningOffsets.unshift({ pos: 1, value: Math.random() * 2 - 1 });\n            }\n            if (this.lightningOffsets[this.lightningOffsets.length - 1].pos > 99) {\n                this.lightningOffsets.pop();\n            }\n        },\n\n        drawLightning(x1, y1, x2, y2) {\n            let vector = vectorBetween({ x: x1, y: y1 }, { x: x2, y: y2 });\n\n            Viewport.ctx.strokeStyle = 'rgba(95, 205, 228, 1)';\n            Viewport.ctx.strokeStyle = 'rgba(190, 235, 250, 1)';\n            Viewport.ctx.lineWidth = 1;\n            Viewport.ctx.fillStyle = 'rgba(190, 235, 250, 1)';\n\n    //        Viewport.ctx.beginPath();\n    //        Viewport.ctx.moveTo(x1, y1);\n            let offset = 0;\n            for (let i = 0; i < vector.m; i++) {\n                let x = x1 + vector.x * i;\n                let y = y1 + vector.y * i;\n\n                let calc = Math.random();\n                if (calc < 0.33) {\n                    offset--;\n                } else if (calc < 0.66) {\n                    offset++;\n                }\n\n                let choke = 0.98 - (i / vector.m);\n\n                x += vector.y * offset * choke;\n                y -= vector.x * offset * choke;\n\n                Viewport.ctx.fillRect(x, y, 1, 1);\n            }\n        },\n\n        drawControlPanel() {\n            let height = 44;\n            Viewport.ctx.fillStyle = '#181425';\n            Viewport.ctx.fillRect(0, Viewport.height - height, Viewport.width, height);\n\n            Viewport.ctx.fillStyle = '#b55088';\n            Viewport.ctx.fillRect(0, Viewport.height - height - 1, Viewport.width, 1);\n\n            Viewport.ctx.fillStyle = '#f6757a';\n            Viewport.ctx.fillRect(0, Viewport.height - height - 2, Viewport.width, 1);\n\n            Viewport.ctx.fillStyle = '#c0cbdc';\n            Viewport.ctx.fillRect(0, Viewport.height - height - 3, Viewport.width, 1);\n        }\n        */\n    };\n\n    // https://jonny.morrill.me/en/blog/gamedev-how-to-implement-a-camera-shake-effect/\n\n    /**\n     * Shake it baby.\n     */\n    class ScreenShake {\n        constructor(frames, hAmplitude, vAmplitude) {\n            this.frames = frames;\n            this.hAmplitude = hAmplitude;\n            this.vAmplitude = vAmplitude;\n            this.hSamples = [];\n            this.vSamples = [];\n\n            var sampleCount = frames / 2;\n            for (let i = 0; i < sampleCount; i++) {\n                this.hSamples.push(Math.random() * 2 - 1);\n                this.vSamples.push(Math.random() * 2 - 1);\n            }\n            this.frame = -1;\n        }\n\n        update() {\n            this.frame++;\n            if (this.frame >= this.frames) {\n                return false;\n            }\n\n            //let s = (this.frames / 10) * (this.frame / this.frames);\n            let s = this.frame / 2;\n            let s0 = s | 0;\n            let s1 = s0 + 1;\n            let decay = 1 - this.frame / this.frames;\n\n            this.x =\n                this.hAmplitude *\n                decay *\n                (this.hSamples[s0] +\n                    (s - s0) * (this.hSamples[s1] - this.hSamples[s0]));\n            this.y =\n                this.vAmplitude *\n                decay *\n                (this.vSamples[s0] +\n                    (s - s0) * (this.vSamples[s1] - this.vSamples[s0]));\n\n            return true;\n        }\n    }\n\n    // This is our list of STATES. Each entity starts out in one of these states and can move between\n    // them based on events that happen in the game. (Note that some of these are directions, but\n    // since an entity keeps moving in the direction it is going unless stopped, directions are\n    // states in this game.)\n    const State = {\n        STOPPED:    1,         // Standing still\n        UP:         2,         // Moving up (player only)\n        LEFT:       3,         // Moving left\n        DOWN:       4,         // Moving down\n        RIGHT:      5,         // Moving right\n        FALLING:    6,         // Falling\n        START_JUMP: 7,         // About to start a jump (player only)\n        JUMP_LEFT:  8,         // Jumping left (player only)\n        JUMP_RIGHT: 9,         // Jumping right (player only)\n        JUMP_UP:    10,        // Jumping straight up (player only)\n        DYING:      11,        // Dying (used as a death animation)\n        DEAD:       12         // Dead (for player, restart level; for rock, disappear)\n    };\n\n    const JUMP_FRAMES = {\n        [State.JUMP_RIGHT]: [\n            { x: 1, y: -1 },\n            { x: 1, y: -1 },\n            { x: 1, y: 0 },\n            { x: 1, y: 0 },\n            { x: 1, y: 1 },\n            { x: 1, y: 1 }\n        ],\n        [State.JUMP_LEFT]: [\n            { x: -1, y: -1 },\n            { x: -1, y: -1 },\n            { x: -1, y: 0 },\n            { x: -1, y: 0 },\n            { x: -1, y: 1 },\n            { x: -1, y: 1 }\n        ],\n        [State.JUMP_UP]: [\n            { x: 0, y: -1 },\n            { x: 0, y: -1 },\n            { x: 0, y: 0 },\n            { x: 0, y: 1 },\n            { x: 0, y: 1 },\n            { x: 0, y: 0 }\n        ],\n    };\n\n    class Entity {\n        applyMovement(field) {\n            let repeat = false;\n\n            // This method contains generic \"movement\" application for all entities, including\n            // Lad (player) and Der Rocks (enemies). Things like falling, moving left/right, etc.,\n            // work the same for both.\n            //\n            // (There's a bunch of jump logic in here too, and moving UP, which really only applies\n            // to players, but that's OK -- Der Rocks just won't attempt those actions.)\n\n            if (this.nextState) {\n                switch (this.state) {\n                    case State.STOPPED:\n                    case State.LEFT:\n                    case State.RIGHT:\n                        if ([State.LEFT, State.RIGHT, State.STOPPED].includes(this.nextState)) {\n                            this.state = this.nextState;\n                            this.nextState = undefined;\n                        }\n                        break;\n\n                    case State.UP:\n                    case State.DOWN:\n                        // Normal\n                        if ([State.LEFT, State.RIGHT].includes(this.nextState)) {\n                            this.state = this.nextState;\n                            this.nextState = undefined;\n                        }\n                        break;\n                }\n            }\n\n            if (this.nextState === State.START_JUMP) {\n                // Special case: the user wants to jump!\n                //\n                // If the player is standing on something solid, we initiate a jump based on the current\n                // movement of the player. If not, we (sort of) ignore the request to jump... although\n                // it does subtly change the behavior upon landing.\n                if (field.onSolid(this.x, this.y)) {\n                    if (this.state === State.STOPPED || this.state === State.FALLING) {\n                        this.state = State.JUMP_UP;\n                        this.jumpStep = 0;\n                        this.nextState = State.STOPPED;\n                    } else if (this.state === State.LEFT || this.state === State.JUMP_LEFT) {\n                        this.state = State.JUMP_LEFT;\n                        this.jumpStep = 0;\n                        this.nextState = State.LEFT;\n                    } else if (this.state === State.RIGHT || this.state === State.JUMP_RIGHT) {\n                        this.state = State.JUMP_RIGHT;\n                        this.jumpStep = 0;\n                        this.nextState = State.RIGHT;\n                    }\n                } else {\n                    if (this.state === State.JUMP_UP || this.state === State.FALLING) {\n                        this.nextState = State.STOPPED;\n                    } else if (this.state === State.JUMP_RIGHT) {\n                        this.nextState = State.RIGHT;\n                    } else if (this.state === State.JUMP_LEFT) {\n                        this.nextState = State.LEFT;\n                    }\n                }\n            } else if (this.nextState === State.UP && field.isLadder(this.x, this.y)) {\n                // Special case: the user wants to go up!\n                //\n                // If the user is on a ladder, we can start ascending. Note that if the user is not\n                // on a ladder we ignore their input, which is intentional -- this allows queued\n                // (pacman) input, where we can tap UP a little before reaching the ladder.\n                this.state = State.UP;\n                this.nextState = undefined;\n            } else if (this.nextState === State.DOWN && (field.isLadder(this.x, this.y) || field.isLadder(this.x, this.y + 1))) {\n                // Special case: the player wants to go down!\n                //\n                // If the player is on (or above) a ladder, we can start descending. Note that if the player is not\n                // on a ladder we ignore their input, which is intentional -- this allows queued\n                // (pacman) input, where we can tap DOWN a little before reaching the ladder.\n                this.state = State.DOWN;\n                this.nextState = undefined;\n            }\n\n            switch (this.state) {\n                case State.LEFT:\n                    if (!field.onSolid(this.x, this.y)) {\n                        this.nextState = State.LEFT;\n                        this.state = State.FALLING;\n                        repeat = true;\n                        break;\n                    }\n                    if (field.emptySpace(this.x - 1, this.y)) {\n                        this.x--;\n                    } else {\n                        this.nextState = State.STOPPED;\n                    }\n                    break;\n\n                case State.RIGHT:\n                    if (!field.onSolid(this.x, this.y)) {\n                        this.nextState = State.RIGHT;\n                        this.state = State.FALLING;\n                        repeat = true;\n                        break;\n                    }\n                    if (field.emptySpace(this.x + 1, this.y)) {\n                        this.x++;\n                    } else {\n                        this.nextState = State.STOPPED;\n                    }\n                    break;\n\n                case State.UP:\n                    if (field.canClimbUp(this.x, this.y - 1)) {\n                        this.y--;\n                    } else {\n                        this.state = State.STOPPED;\n                    }\n                    break;\n\n                case State.DOWN:\n                    if (field.canClimbDown(this.x, this.y + 1)) {\n                        this.y++;\n                    } else {\n                        this.state = State.STOPPED;\n                    }\n                    break;\n\n                case State.JUMP_RIGHT:\n                case State.JUMP_LEFT:\n                case State.JUMP_UP:\n                    let step = JUMP_FRAMES[this.state][this.jumpStep];\n                    console.log(['jump', this.state, this.jumpStep, step]);\n                    if ((this.x + step.x >= 0) && (this.x + step.x < LEVEL_COLS)) {\n                        let terrain = field.layout[this.y + step.y][this.x + step.x];\n                        if (['=', '|', '-'].includes(terrain)) {\n                            if (field.onSolid(this.x, this.y)) {\n                                this.state = this.nextState;\n                                this.nextState = undefined;\n                            } else {\n                                switch (this.state) {\n                                    case State.JUMP_RIGHT:\n                                        this.nextState = State.RIGHT;\n                                        break;\n                                    case State.JUMP_LEFT:\n                                        this.nextState = State.LEFT;\n                                        break;\n                                    case State.JUMP_UP:\n                                        this.nextState = State.UP;\n                                        break;\n                                }\n                                this.state = State.FALLING;\n                            }\n                        } else if (terrain === 'H') {\n                            this.x += step.x;\n                            this.y += step.y;\n                            this.state = State.STOPPED;\n                            this.nextState = undefined;\n                        } else {\n                            this.x += step.x;\n                            this.y += step.y;\n                            this.jumpStep++;\n\n                            if (this.jumpStep >= JUMP_FRAMES[this.state].length) {\n                                this.state = this.nextState;\n                                this.nextState = undefined;\n                            }\n                        }\n                    } else {\n                        if (field.onSolid(this.x, this.y)) {\n                            this.state = this.nextState;\n                            this.nextState = undefined;\n                        } else {\n                            this.state = State.FALLING;\n                            this.nextState = State.STOPPED;\n                        }\n                    }\n                    break;\n\n                case State.FALLING:\n                    if (field.onSolid(this.x, this.y)) {\n                        this.state = this.nextState || State.STOPPED;\n                    } else {\n                        this.y++;\n                    }\n                    break;\n            }\n\n            // If we were attempting to move somewhere and realized we should be falling instead,\n            // we want to re-run the entire algorithm once. This avoids what boils down to a \"skipped\n            // frame\" from the user's point of view.\n            if (repeat) return this.applyMovement(field);\n        }\n    }\n\n    const Screen = {\n        init() {\n            this.screen = [];\n            for (let y = 0; y < SCREEN_HEIGHT; y++) {\n                this.screen.push([]);\n            }\n            this.clear();\n        },\n\n        clear() {\n            for (let y = 0; y < SCREEN_HEIGHT; y++) {\n                for (let x = 0; x < SCREEN_WIDTH; x++) {\n                    this.screen[y][x] = ' ';\n                }\n            }\n        },\n\n        write(x, y, text) {\n            if (!Array.isArray(text)) text = [text];\n\n            for (let j = 0; j < text.length; j++) {\n                for (let i = 0; i < text[j].length; i++) {\n                    this.screen[y + j][x + i] = text[j][i];\n                }\n            }\n        },\n\n        drawToViewport() {\n            let text = this.screen.map(row => row.join('')).join('\\n');\n\n            Text.drawText(\n                Viewport.ctx,\n                Text.splitParagraph(text, Viewport.width),\n                0, 0,\n                1,\n                Text.terminal, Text.terminal_shadow\n            );\n        }\n    };\n\n    const DEATH_FRAMES = ['p', 'b', 'd', 'q', 'p', 'b', 'd', 'q', '-', '-', '_'];\n\n    /**\n     * Player\n     */\n    class Player extends Entity {\n        constructor(x, y) {\n            super();\n            this.x = x;\n            this.y = y;\n            this.state = State.STOPPED;\n            this.nextState = State.STOPPED;\n            this.jumpStep = 0;\n            this.deathStep = 0;\n            console.log('player constructed', x, y);\n        }\n\n        update(field) {\n            if (this.state === State.DYING) {\n                this.deathStep++;\n                if (this.deathStep >= DEATH_FRAMES.length) this.state = State.DEAD;\n            }\n\n            if (this.state === State.DYING || this.state === State.DEAD) return;\n\n            if (Input.pressed[Input.Action.LEFT]) {\n                this.nextState = State.LEFT;\n            }\n\n            if (Input.pressed[Input.Action.RIGHT]) {\n                this.nextState = State.RIGHT;\n            }\n\n            if (Input.pressed[Input.Action.UP]) {\n                this.nextState = State.UP;\n            }\n\n            if (Input.pressed[Input.Action.DOWN]) {\n                this.nextState = State.DOWN;\n            }\n\n            if (Input.pressed[Input.Action.JUMP]) {\n                this.nextState = State.START_JUMP;\n            }\n\n            return this.applyMovement(field);\n        }\n\n        draw() {\n            let char = 'g';\n\n            switch (this.state) {\n                case State.RIGHT:\n                case State.JUMP_RIGHT:\n                case State.UP:\n                case State.DOWN:\n                    char = 'p';\n                    break;\n\n                case State.LEFT:\n                case State.JUMP_LEFT:\n                    char = 'q';\n                    break;\n\n                case State.FALLING:\n                    char = 'b';\n                    break;\n\n                case State.DYING:\n                    char = DEATH_FRAMES[this.deathStep];\n                    break;\n\n                case State.DEAD:\n                    char = '_';\n                    break;\n            }\n\n            Screen.write(this.x, this.y, char);\n        }\n    }\n\n    const DEATH_FRAMES$1 = ['%', ':'];\n\n    class Rock extends Entity {\n        constructor(dispenser) {\n            super();\n            this.x = dispenser.x;\n            this.y = dispenser.y + 1;\n            this.state = State.FALLING;\n            this.nextState = undefined;\n            this.deathStep = 0;\n        }\n\n        update(field) {\n            if (this.state === State.DYING) {\n                this.deathStep++;\n                if (this.deathStep >= DEATH_FRAMES$1.length) this.state = State.DEAD;\n            }\n\n            if (this.state === State.DYING || this.state === State.DEAD) return;\n\n            if (this.state === State.STOPPED) {\n                if (this.x === 0 || !field.emptySpace(this.x - 1, this.y)) {\n                    this.nextState = State.RIGHT;\n                } else if (this.x === LEVEL_COLS - 1 || !field.emptySpace(this.x + 1, this.y)) {\n                    this.nextState = State.LEFT;\n                } else {\n                    this.nextState = Math.random() > 0.5 ? State.LEFT : State.RIGHT;\n                }\n            }\n\n            if (this.x === 0 && this.state === State.LEFT) {\n                this.state = State.RIGHT;\n            }\n\n            if (this.x === LEVEL_COLS - 1 && this.state === State.RIGHT) {\n                this.state = State.LEFT;\n            }\n\n            if (this.state !== State.FALLING && !field.onSolid(this.x, this.y)) {\n                this.nextState = State.FALLING;\n            }\n\n            if (field.isLadder(this.x, this.y + 1) && [State.LEFT, State.RIGHT].includes(this.state)) {\n                let r = Math.floor(Math.random() * 4);\n                this.nextState = [State.LEFT, State.RIGHT, State.DOWN, State.DOWN][r];\n            }\n\n            if (field.isEater(this.x, this.y)) {\n                this.state = State.DYING;\n                return;\n            }\n\n            this.applyMovement(field);\n        }\n\n        draw() {\n            let char = 'o';\n\n            switch (this.state) {\n                case State.DYING:\n                    char = DEATH_FRAMES$1[this.deathStep];\n                    break;\n                case State.DEAD:\n                    return;\n            }\n\n            Screen.write(this.x, this.y, char);\n        }\n    }\n\n    var LevelData = [\n    \t{\n    \t\tname: \"Easy Street\",\n    \t\ttime: 35,\n    \t\tmaxRocks: 5,\n    \t\tlayout: [\n    \t\t\t\"                                       V                 $                     \",\n    \t\t\t\"                                                         H                     \",\n    \t\t\t\"                H                                        H                     \",\n    \t\t\t\"       =========H==================================================            \",\n    \t\t\t\"                H                                                              \",\n    \t\t\t\"                H                                                              \",\n    \t\t\t\"                H          H                             H                     \",\n    \t\t\t\"================H==========H==================   ========H=====================\",\n    \t\t\t\"                &          H                             H          |       |  \",\n    \t\t\t\"                                                         H         Easy Street \",\n    \t\t\t\"                H                                        H                     \",\n    \t\t\t\"       =========H==========H=========  =======================                 \",\n    \t\t\t\"                H                                                              \",\n    \t\t\t\"                H                                                              \",\n    \t\t\t\"                H                                        H                     \",\n    \t\t\t\"======================== ====================== =========H==============       \",\n    \t\t\t\"                                                         H                     \",\n    \t\t\t\"                                                         H                     \",\n    \t\t\t\"*    p                                                   H                    *\",\n    \t\t\t\"===============================================================================\"\n    \t\t]\n    \t},\n    \t{\n    \t\tname: \"Long Island\",\n    \t\ttime: 45,\n    \t\tmaxRocks: 8,\n    \t\tlayout: [\n    \t\t\t\"                                                                          $    \",\n    \t\t\t\"                                                                   &      H    \",\n    \t\t\t\"    H       |V                                                     V|     H    \",\n    \t\t\t\"====H======================= ========================= ======================  \",\n    \t\t\t\"    H                                                                          \",\n    \t\t\t\"    H                                                                          \",\n    \t\t\t\"    H                    & |                         . .                  H    \",\n    \t\t\t\"========================== ======  =================== ===================H==  \",\n    \t\t\t\"                                                                          H    \",\n    \t\t\t\"                                  |                                       H    \",\n    \t\t\t\"    H                             |                 .  .                  H    \",\n    \t\t\t\"====H=====================   ======  ================  ======================  \",\n    \t\t\t\"    H                                                                          \",\n    \t\t\t\"    H                      |                                                   \",\n    \t\t\t\"    H                      |                        .   .                 H    \",\n    \t\t\t\"=========================  ========    ==============   ==================H==  \",\n    \t\t\t\"                                                                          H    \",\n    \t\t\t\"==============                      |                                     H    \",\n    \t\t\t\" Long Island |   p         *        |                 *                   H    \",\n    \t\t\t\"===============================================================================\"\n    \t\t]\n    \t},\n    \t{\n    \t\tname: \"Ghost Town\",\n    \t\ttime: 35,\n    \t\tmaxRocks: 5,\n    \t\tlayout: [\n    \t\t\t\"                            V               V           V               $      \",\n    \t\t\t\"                                                                       $$$     \",\n    \t\t\t\"     p    H                                                    H      $$$$$   H\",\n    \t\t\t\"==========H===                                                =H==============H\",\n    \t\t\t\"          H                                                    H              H\",\n    \t\t\t\"          H                              &                     H              H\",\n    \t\t\t\"     ==============   ====     =    ======    =   ====    =====H=====         H\",\n    \t\t\t\"    G              ^^^    ^^^^^ ^^^^      ^^^^ ^^^    ^^^                     $\",\n    \t\t\t\"    h                                                                 |        \",\n    \t\t\t\"    o     |                     H                             &       |        \",\n    \t\t\t\"    s     ======================H============================== ===========    \",\n    \t\t\t\"    t        &                  H                                              \",\n    \t\t\t\"                                H                                              \",\n    \t\t\t\"              |                 H                 H                   H        \",\n    \t\t\t\"    T         ==================H=================H===================H======= \",\n    \t\t\t\"    o                                             H                   H        \",\n    \t\t\t\"    w                                                                 H        \",\n    \t\t\t\"    n                           ^                                     H        \",\n    \t\t\t\"*                              ^^^                                    H       *\",\n    \t\t\t\"===============================================================================\"\n    \t\t]\n    \t},\n    \t{\n    \t\tname: \"Tunnel Vision\",\n    \t\ttime: 36,\n    \t\trocks: 5,\n    \t\tlayout: [\n    \t\t\t\"                                            V                       V          \",\n    \t\t\t\"                                                                               \",\n    \t\t\t\"     H             H                         |                H                \",\n    \t\t\t\"=====H=====--======H==========================     ===----====H===========     \",\n    \t\t\t\"     H             H                |&&                       H                \",\n    \t\t\t\"     H             H                ==================        H                \",\n    \t\t\t\"     H             H                       tunnel  H          H                \",\n    \t\t\t\"     H           =======---===----=================H=         H           H    \",\n    \t\t\t\"     H         |                           vision  H          H           H    \",\n    \t\t\t\"     H         =========---&      -----============H          H           H    \",\n    \t\t\t\"     H           H                                 H |        H           H    \",\n    \t\t\t\"     H           H=========----===----================        H  ==============\",\n    \t\t\t\"                 H                                        &   H                \",\n    \t\t\t\"                 H                                        |   H                \",\n    \t\t\t\"====---====      H                                        |   H                \",\n    \t\t\t\"|         |    ================---===---===================   H                \",\n    \t\t\t\"|   ===   |                                                   H        H    p  \",\n    \t\t\t\"|    $    |                                                   H     ===H=======\",\n    \t\t\t\"|*  $$$  *|   *                *       *                     *H       *H       \",\n    \t\t\t\"===============================================================================\"\n    \t\t]\n    \t},\n    \t{\n    \t\tname: \"Point of No Return\",\n    \t\ttime: 35,\n    \t\tmaxRocks: 7,\n    \t\tlayout: [\n    \t\t\t\"         $                                                                     \",\n    \t\t\t\"         H                                                   V                 \",\n    \t\t\t\"         H                                                                     \",\n    \t\t\t\"         HHHHHHHHHHHHH     .HHHHHHHHHHHHHH                          H    p     \",\n    \t\t\t\"         &                   V           H                        ==H==========\",\n    \t\t\t\"                                         H                          H          \",\n    \t\t\t\"   H                                     H        .                 H          \",\n    \t\t\t\"===H==============-----------============H====                      H          \",\n    \t\t\t\"   H                                                      H         H          \",\n    \t\t\t\"   H                                                 =====H==============      \",\n    \t\t\t\"   H                                     H                H                    \",\n    \t\t\t\"   H              &..^^^.....^..^ . ^^   H==---------     H                    \",\n    \t\t\t\"   H         ============================H    &           H             H      \",\n    \t\t\t\"   H         ===      ===      ===       H    ---------=================H======\",\n    \t\t\t\"   H                                     H                              H      \",\n    \t\t\t\"   H                          &          H          &                   H      \",\n    \t\t\t\"   ==========-------------------------=======----------===================     \",\n    \t\t\t\"                                                                               \",\n    \t\t\t\"^^^*         ^^^^^^^^^^^^^^^^^^^^^^^^^*     *^^^^^^^^^^*Point of No Return*^^^^\",\n    \t\t\t\"===============================================================================\"\n    \t\t]\n    \t},\n    \t{\n    \t\tname: \"Bug City\",\n    \t\ttime: 37,\n    \t\tmaxRocks: 6,\n    \t\tlayout: [\n    \t\t\t\"        Bug City             HHHHHHHH                          V               \",\n    \t\t\t\"                           HHH      HHH                                        \",\n    \t\t\t\"   H                                          >mmmmmmmm                        \",\n    \t\t\t\"   H===============                   ====================          H          \",\n    \t\t\t\"   H              |=====       \\\\  /         V                  =====H==========\",\n    \t\t\t\"   H                            \\\\/                                  H          \",\n    \t\t\t\"   H                                        | $                     H          \",\n    \t\t\t\"   H           H                            | H                     H          \",\n    \t\t\t\"   H       ====H=======          p          |&H    H                H          \",\n    \t\t\t\"   H           H             ======================H           ======          \",\n    \t\t\t\"   H           H      &|                           H                    H      \",\n    \t\t\t\"   H           H      &|                    H      H     }{        =====H====  \",\n    \t\t\t\"===H===&       H       =====================H      H                    H      \",\n    \t\t\t\"               H                            H      H                    H      \",\n    \t\t\t\"               H                            H      &                    H      \",\n    \t\t\t\"         ======H===   =======    H    <>    &                           H      \",\n    \t\t\t\"                                 H==========       =====     =     ============\",\n    \t\t\t\"     }i{                         H                                             \",\n    \t\t\t\"*                                H                                            *\",\n    \t\t\t\"===============================================================================\"\n    \t\t]\n    \t},\n    \t{\n    \t\tname: \"GangLand\",\n    \t\ttime: 32,\n    \t\tmaxRocks: 6,\n    \t\tlayout: [\n    \t\t\t\"                    =Gang Land=                             V                  \",\n    \t\t\t\"                   ==      _  ==                                      .        \",\n    \t\t\t\"      p    H        |  [] |_| |                  &                    .  H     \",\n    \t\t\t\"===========H        |     |_| |       H         ===   ===================H     \",\n    \t\t\t\"      V    H        =============     H======                            H     \",\n    \t\t\t\"           H                          H                     &            H     \",\n    \t\t\t\"           H                          H                |    |            H     \",\n    \t\t\t\"    H      H        ^^^&&^^^ & ^  ^^^ H           H    |    =============H     \",\n    \t\t\t\"    H======H   =======================H===========H=====          &      H     \",\n    \t\t\t\"    H                                 H           H    |         &&&     H     \",\n    \t\t\t\"    H                                 H           H    |        &&&&&    H     \",\n    \t\t\t\"    H                                 H           H    |    =============H     \",\n    \t\t\t\"              =====------=================        H    |       $     $         \",\n    \t\t\t\"                                         |        H    |      $$$   $$$        \",\n    \t\t\t\"====------===                            |        H    |     $$$$$ $$$$$       \",\n    \t\t\t\"            |       =                    | =============    ============       \",\n    \t\t\t\"            |       $                     ^          &                         \",\n    \t\t\t\"            |^^^^^^^^^^^^^^      $ ^              ======                       \",\n    \t\t\t\"*                   .      &   ^ H*^                    ^  ^       ^^^^^^^^^^^^\",\n    \t\t\t\"===============================================================================\"\n    \t\t]\n    \t}\n    ];\n\n    const Level = {\n        LEVELS: LevelData,\n\n        load(levelNumber) {\n            console.log(Level.LEVELS);\n            // As the player keeps playing, level numbers will loop around to beginning\n            let level = Level.LEVELS[levelNumber % Level.LEVELS.length];\n            if (!level) throw new Error(`No such level number: ${levelNumber}`);\n\n            // Perform some sanity checks on the level layout and extract useful info\n            // like player start position and dispenser positions etc.\n\n            let layout = level.layout.map(row => row.split(''));\n            let dispensers = [];\n            let player;\n\n            // Sanity check\n            layout = layout.slice(0, LEVEL_ROWS);\n\n            for (let y = 0; y < LEVEL_ROWS; y++) {\n                // Sanity checks\n                if (!layout[y]) layout[y] = [];\n                layout[y] = layout[y].slice(0, LEVEL_COLS);\n\n                for (let x = 0; x < LEVEL_COLS; x++) {\n                    // Sanity check\n                    if (!layout[y][x]) layout[y][x] = ' ';\n\n                    // Der Dispensers (V) and Der Eaters (*) have behaviors, so it is convenient for us\n                    // to construct a list of them, but they are permanent parts of the layout, so we can\n                    // leave them as part of the level and draw them normally.\n\n                    if (layout[y][x] === 'V') {\n                        dispensers.push({ x, y });\n                    }\n\n                    // Treasure ($), Statues (&), and the Lad (p) are transient - the player moves around and\n                    // can pick up the treasures and statues. That's why for these elements, we add them to\n                    // our lists AND we remove them from the \"playing field\", we'll draw them separately on\n                    // top of the layout.\n\n                    if (layout[y][x] === 'p') {\n                        layout[y][x] = ' ';\n                        player = { x, y };\n                    }\n\n                    // Everything else, like floors (=), walls (|), ladders (H) and fire (^), is part of the\n                    // layout. The Lad interacts with them, but we can handle that during our movement checks.\n                }\n            }\n\n            return {\n                name: level.name,\n                time: level.time,\n                maxRocks: level.maRrocks,\n                layout,\n                dispensers,\n                player\n            };\n        }\n    };\n\n    /**\n     * Field\n     *\n     * The \"field\" represents the current level, or, \"playing field\". A new playing field is created\n     * every time you start a level, so we attach everything about the currently played level to\n     * the field -- positions of treasure, the player, victory conditions, etc.\n     */\n    class Field {\n        constructor(levelNumber) {\n            let level = Level.load(levelNumber);\n\n            this.layout = level.layout;\n            this.dispensers = level.dispensers;\n            this.time = level.time;\n            this.maxRocks = level.rocks;\n            this.rocks = [];\n            this.player = new Player(level.player.x, level.player.y);\n        }\n\n        update(session) {\n            let oldX = this.player.x, oldY = this.player.y;\n\n            // Move player based on user input\n            this.player.update(this);\n\n            if (oldX !== this.player.x && oldY === this.player.y) {\n                if (this.isDisappearingFloor(oldX, oldY + 1)) {\n                    this.layout[oldY + 1][oldX] = ' ';\n                }\n            }\n\n            // Check if player should be dead (before moving rocks)\n            this.checkIfPlayerShouldDie(session);\n\n            // Move rocks\n            for (let rock of this.rocks) rock.update(this);\n\n            // Check if player should be dead (after moving rocks)\n            this.checkIfPlayerShouldDie(session);\n\n            // Collect statues\n            if (this.isStatue(this.player.x, this.player.y)) {\n                this.layout[this.player.y][this.player.x] = ' ';\n                session.updateScore(SCORE_STATUE);\n            }\n\n            // Collect treasure (ends the current level)\n            if (this.isTreasure(this.player.x, this.player.y)) {\n                session.startNextLevel();\n            }\n\n            // Interact with trampolines\n            if (this.isTrampoline(this.player.x, this.player.y)) {\n                switch (Math.floor(Math.random() * 5)) {\n                    case 0:\n                        this.player.state = State.LEFT;\n                        this.player.nextState = undefined;\n                        break;\n                    case 1:\n                        this.player.state = State.RIGHT;\n                        this.player.nextState = undefined;\n                        break;\n                    case 2:\n                        this.player.state = State.JUMP_UP;\n                        this.player.nextState = undefined;\n                        this.player.jumpStep = 0;\n                        break;\n                    case 3:\n                        this.player.state = State.JUMP_LEFT;\n                        this.player.nextState = State.LEFT;\n                        this.player.jumpStep = 0;\n                        break;\n                    case 4:\n                        this.player.state = State.JUMP_RIGHT;\n                        this.player.nextState = State.RIGHT;\n                        this.player.jumpStep = 0;\n                        break;\n                }\n            }\n\n            // Dispense new rocks\n            if (this.rocks.length < 3 && Math.random() > 0.9) {\n                let dispenser = this.dispensers[Math.floor(Math.random() * this.dispensers.length)];\n                this.rocks.push(new Rock(dispenser));\n            }\n\n            // Kill dead rocks\n            this.rocks = this.rocks.filter(rock => rock.state !== State.DEAD);\n\n            // Kill player\n            if (this.player.state === State.DEAD) {\n                session.restartLevel();\n            }\n        }\n\n        draw() {\n            // Draw layout\n            Screen.write(0, 0, this.layout.map(row => row.join('')));\n\n            // Draw player\n            this.player.draw();\n\n            // Draw rocks\n            this.rocks.forEach(rock => rock.draw());\n        }\n\n        onSolid(x, y) {\n            return ['=', '-', 'H', '|'].includes(this.layout[y + 1][x]) || this.layout[y][x] === 'H';\n        }\n\n        emptySpace(x, y) {\n            if (x < 0 || x >= LEVEL_COLS) {\n                return false;\n            } else {\n                return !['|', '='].includes(this.layout[y][x]);\n            }\n        }\n\n        isLadder(x, y) {\n            return this.layout[y][x] === 'H';\n        }\n\n        isStatue(x, y) {\n            return this.layout[y][x] === '&';\n        }\n\n        isTreasure(x, y) {\n            return this.layout[y][x] === '$';\n        }\n\n        isTrampoline(x, y) {\n            return this.layout[y][x] === '.';\n        }\n\n        isEater(x, y) {\n            return this.layout[y][x] === '*';\n        }\n\n        isFire(x, y) {\n            return this.layout[y][x] === '^';\n        }\n\n        isDisappearingFloor(x, y) {\n            return this.layout[y][x] === '-';\n        }\n\n        canClimbUp(x, y) {\n            return ['H', '&', '$'].includes(this.layout[y][x]);\n        }\n\n        canClimbDown(x, y) {\n            return ['H', '&', '$', ' ', '^', '.'].includes(this.layout[y][x]);\n        }\n\n        checkIfPlayerShouldDie(session) {\n            if (this.player.state === State.DYING || this.player.state === State.DEAD) return;\n\n            if (this.isFire(this.player.x, this.player.y)) {\n                this.player.state = State.DYING;\n            }\n\n            for (let i = 0; i < this.rocks.length; i++) {\n                if (this.player.x === this.rocks[i].x) {\n                    if (this.player.y === this.rocks[i].y) {\n                        this.player.state = State.DYING;\n                        this.rocks.splice(i, 1);\n                        break;\n                    } else if (this.player.y === this.rocks[i].y - 1 && this.emptySpace(this.player.x, this.player.y + 1)) {\n                        session.updateScore(SCORE_ROCK);\n                    } else if (this.player.y === this.rocks[i].y - 2 && this.emptySpace(this.player.x, this.player.y + 1) && this.emptySpace(this.player.x, this.player.y + 2)) {\n                        session.updateScore(SCORE_ROCK);\n                    }\n                }\n            }\n        }\n    }\n\n    class MainMenu {\n        constructor() {\n        }\n\n        update() {\n            switch (Input.lastKeyPressed().toUpperCase()) {\n                case 'P':\n                    Input.consume();\n                    game.startSession();\n                    break;\n                case 'L':\n                    Input.consume();\n                    game.playSpeed = (game.playSpeed + 1) % PLAY_SPEEDS.length;\n                    break;\n                case 'I':\n                    Input.consume();\n                    game.showInstructions();\n                    break;\n                case 'E':\n                    Input.consume();\n                    game.showInstructions();\n                    break;\n            }\n        }\n\n        draw() {\n            let version = '?';\n            let terminal = '?';\n\n            let highScores = [\n                `1) 6000  Bob`,\n                `2) 6000  Tom`,\n                `3) 4000  Wayne`,\n                ``,\n                ``\n            ];\n\n            Screen.clear();\n            Screen.write(0, 0, [\n                `               LL                     dd       dd`,\n                `               LL                     dd       dd                      tm`,\n                `               LL         aaaa     ddddd    ddddd    eeee   rrrrrrr`,\n                `               LL        aa  aa   dd  dd   dd  dd   ee  ee  rr    rr`,\n                `               LL        aa  aa   dd  dd   dd  dd   eeeeee  rr`,\n                `               LL        aa  aa   dd  dd   dd  dd   ee      rr`,\n                `               LLLLLLLL   aaa aa   ddd dd   ddd dd   eeee   rr`,\n                ``,\n                `                                       Version:    ${version}`,\n                `(c) 1982, 1983 Yahoo Software          Terminal:   ${terminal}`,\n                `10970 Ashton Ave.  Suite 312           Play speed: ${game.playSpeed + 1} / ${PLAY_SPEEDS.length}`,\n                `Los Angeles, Ca  90024                 Move = /WASD, Jump = Space,`,\n                `                                       Stop = Other`,\n                ``,\n                `P = Play game                          High Scores`,\n                `L = Change level of difficulty         ${highScores[0]}`,\n                `C = Configure Ladder                   ${highScores[1]}`,\n                `I = Instructions                       ${highScores[2]}`,\n                `E = Exit Ladder                        ${highScores[3]}`,\n                `                                       ${highScores[4]}`,\n                ``,\n                `Enter one of the above:`\n            ]);\n        }\n    }\n\n    class InstructionsMenu {\n        constructor() {\n        }\n\n        update() {\n            if (Input.lastKeyPressed().toUpperCase() !== '') {\n                Input.consume();\n                game.showMainMenu();\n            }\n        }\n\n        draw() {\n            Screen.clear();\n            Screen.write(0, 0, [\n                `You are a Lad trapped in a maze.  Your mission is is to explore the`,\n                `dark corridors never before seen by human eyes and find hidden`,\n                `treasures and riches.`,\n                ``,\n                `You control Lad by typing the direction buttons and jumping by`,\n                `typing SPACE.  But beware of the falling rocks called Der rocks.`,\n                `You must find and grasp the treasures (shown as $) BEFORE the`,\n                `bonus time runs out.`,\n                ``,\n                `A new Lad will be awarded for every 10,000 points.`,\n                `Extra points are awarded for touching the gold`,\n                `statues (shown as &).  You will receive the bonus time points`,\n                `that are left when you have finished the level.`,\n                ``,\n                `Type an ESCape to pause the game.`,\n                ``,\n                `Remember, there is more than one way to skin a cat. (Chum)`,\n                ``,\n                `Good luck Lad.`,\n                ``,\n                ``,\n                ``,\n                `Type RETURN to return to main menu:`\n            ]);\n        }\n    }\n\n    class Session {\n        constructor() {\n            this.score = 0;\n            this.levelNumber = 0;\n            this.levelCycle = 1;\n            this.lives = 5;\n            this.nextLife = 100;\n        }\n\n        update() {\n            if (!this.field) {\n                this.field = new Field(this.levelNumber);\n            }\n\n            this.field.update(this);\n\n            let recentKeystrokes = Input.buffer.map(event => event.key).join('').toUpperCase();\n\n            if (recentKeystrokes.match(/IDCLEV(\\d\\d)/)) {\n                Input.consume();\n                this.field = undefined;\n                this.levelNumber = parseInt(RegExp.$1, 10);\n            } else if (recentKeystrokes.includes(\"IDDQD\")) {\n                Input.consume();\n                console.log(\"god mode\");\n            }\n        }\n\n        draw() {\n            Screen.clear();\n\n            if (this.field) this.field.draw();\n\n            let stat = [\n                String(this.lives).padStart(2, ' '),\n                String(this.levelNumber + 1).padStart(2, ' '),\n                String(this.score).padStart(4, '0'),\n                this.field ? String(this.field.time).padStart(4, ' ') : ''\n            ];\n            Screen.write(0, 21, `Lads   ${stat[0]}   Level   ${stat[1]}    Score   ${stat[2]}    Bonus time   ${stat[3]}`);\n        }\n\n        restartLevel() {\n            this.field = undefined;\n        }\n\n        startNextLevel() {\n            this.field = undefined;\n            this.levelNumber++;\n            if (this.levelNumber % LEVEL_ORDER.length === 0) {\n                this.levelCycle++;\n            }\n        }\n\n        updateScore(scoreType) {\n            switch (scoreType) {\n                case SCORE_ROCK:\n                    this.score += 2;\n                    break;\n                case SCORE_STATUE:\n                    this.score += this.field.time;\n                    break;\n                case SCORE_TREASURE:\n                    // Called repeatedly during the end-of-level event.\n                    this.score += 1;\n                    break;\n            }\n        }\n    }\n\n    /**\n     * Game state.\n     */\n    class Game {\n        init() {\n            Sprite.loadSpritesheet(async () => {\n                await Viewport.init();\n                await Screen.init();\n                await Sprite.init();\n                await Terrain.init();\n                Text.init();\n                Hud.init();\n                Input.init();\n                Audio.init();\n\n                this.entities = [];\n                this.dialogPending = {};\n                this.dialogSeen = {};\n                this.roomsCleared = {};\n                this.shadowOffset = 0;\n                this.screenshakes = [];\n                this.camera = { pos: { x: 0, y: 0 } };\n                this.cameraFocus = { pos: { x: 0, y: 0 } };\n\n                window.addEventListener('blur', () => this.pause());\n                window.addEventListener('focus', () => this.unpause());\n\n                this.start();\n            });\n        }\n\n        start() {\n            this.fps = 20;\n            this.frame = 0;\n            this.frameTimes = [];\n\n            this.menu = new MainMenu();\n\n            this.playSpeed = 0;\n\n            this.update();\n            window.requestAnimationFrame((delta) => this.onFrame(delta));\n        }\n\n        onFrame() {\n            // If we're in a menu screen, default to a reasonable 30 FPS.\n            // If we're in a game, use the player's selected play speed.\n            let desiredFps = this.session ? PLAY_SPEEDS[this.playSpeed] : 30;\n            let now = new Date().getTime();\n            let lastFrame = this.lastFrame || 0;\n\n            if (now - lastFrame >= 1000 / desiredFps) {\n                this.update();\n                this.lastFrame = now;\n            }\n\n            // No matter what the game FPS is, we'll resize and redraw the screen\n            // on every browser animation frame (usually 60 FPS).\n            Viewport.resize();\n            this.draw(Viewport.ctx);\n            window.requestAnimationFrame(() => this.onFrame());\n        }\n\n        update() {\n            // Pull in frame by frame button pushes / keypresses / mouse clicks\n            Input.update();\n\n            this.handleInput();\n            /*game.camera.pos.x += 0.1;\n            game.camera.pos.y -= 0.1;*/\n\n            //if (Input.pressed[Input.Action.MENU]) {\n            //    this.paused ? this.unpause() : this.pause();\n            //}\n\n            if (this.paused) return;\n\n            // perform any per-frame audio updates\n            Audio.update();\n\n            // Behavior (AI, player input, etc.)\n            //perform(this.entities); <-- cut to save space\n\n            // perform any queued damage\n            //Damage.perform(this.entities);\n\n            // Movement (perform entity velocities to position)\n\n            // Dialog scheduling\n            //DialogScheduling.perform();\n\n            // Victory conditions\n\n            if (this.menu) {\n                this.menu.update();\n            }\n\n            /*    if (!this.session) {\n                this.session = new Session();\n            }*/\n\n            if (this.session) this.session.update();\n\n            // Culling (typically when an entity dies)\n\n            // Camera logic\n            /*let diff = {\n                x: this.player.pos.x - this.camera.pos.x,\n                y: this.player.pos.y - this.camera.pos.y\n            };*/\n\n            /*\n            this.camera.pos.x += diff.x * 0.2;\n            this.camera.pos.y += diff.y * 0.2;\n            */\n\n            // Tick screenshakes and cull finished screenshakes\n            this.screenshakes = this.screenshakes.filter(screenshake =>\n                screenshake.update()\n            );\n\n            // Flickering shadows\n            if (game.frame % 6 === 0) this.shadowOffset = (Math.random() * 10) | 0;\n\n            // Intro screenshake\n            if (game.frame === 30) game.screenshakes.push(new ScreenShake(20, 20, 20));\n\n            // Initial \"click\" to get game started\n            if (Input.pressed[Input.Action.ATTACK] && !game.started) game.started = true;\n\n            if (Input.pressed[Input.Action.ATTACK]) {\n                // make a laser\n                this.laser = 45;\n            }\n        }\n\n        draw() {\n            // Reset canvas transform and scale\n            Viewport.ctx.setTransform(Viewport.scale, 0, 0, Viewport.scale, 0, 0);\n\n            Viewport.ctx.fillStyle = 'black';\n            Viewport.ctx.fillRect(0, 0, Viewport.width, Viewport.height);\n\n            Viewport.ctx.translate((Viewport.width - GAME_WIDTH) / 2 | 0, (Viewport.height - GAME_HEIGHT) / 2 | 0);\n\n            if (this.session) this.session.draw();\n            if (this.menu) this.menu.draw();\n\n            Screen.drawToViewport();\n\n            return;\n\n            /* laser code\n            if (this.laser > 0 && this.laser < 42) {\n                let center = (Viewport.width / 2) | 0, x = 0;\n                for (let y = -5; y < Viewport.height; y++) {\n                    let choices = [-1, 0, 0, 1];\n                    if (x < -10) choices[0] = 1;\n                    if (x > 10) choices[3] = -1;\n\n                    //let vx = x + Math.sin(y + ((this.frame / 10) % 10)) * Math.cos(this.frame / 19) * 10;\n                    Viewport.ctx.fillStyle = 'rgba(50,200,50,1)';\n                    Viewport.ctx.fillRect(center + x - 10, y, this.laser > 35 ? 30 : 20, 1);\n                    x += choices[(Math.random() * 4) | 0];\n                }\n            }\n            this.laser--;\n            */\n\n    /*\n                for (let i = 0; i < 5; i++) {\n                    let column = (Math.random() * Viewport.width) | 0;\n                    let row = ((Math.random() * Viewport.height) | 0) - 50;\n                    let length = ((Math.random() * 50) | 0) + 50;\n                    let color = [\n                        //'rgba(34, 179, 34, 1)',  // base color\n                        'rgba(39, 204, 39, 1)',    // brighter version\n                        'rgba(25, 128, 25, 1)',    // darker version\n                        'rgba(195, 230, 195, 1)'\n                    ][(Math.random() * 3) | 0];\n\n                    this.laserRand = this.laserRand || [];\n                    this.laserRand.push([column, row, length, color, 30]);\n                }\n\n                for (let laser of this.laserRand) {\n                    laser[4]--;\n                    Viewport.ctx.fillStyle = laser[3];\n                    Viewport.ctx.fillRect(laser[0], laser[1], 1, laser[2]);\n\n                    laser[1]+=2;\n                    console.log(laser[3]);\n                }\n\n                this.laserRand = this.laserRand.filter(l => l[4] > 0);*/\n\n                /*\n                canvas.ctx.fillRect(x, y, 1, 1);\n                src/js/Sprite.js:    canvas.ctx.fillRect(0, 0, 500, 500);\n                src/js/Sprite.js:    canvas.ctx.fillRect(0, 0, 32, 32);\n                src/js/Sprite.js:    canvas.ctx.fillRect(0, 0, source.width, source.height);\n                src/js/Viewport.js:        Viewport.ctx.fillRect(0, 0, Viewport.width, Vi\n                    */\n\n        }\n\n        pause() {\n            if (this.paused) return;\n            this.paused = true;\n            Audio.pause();\n        }\n\n        unpause() {\n            if (!this.paused) return;\n            this.paused = false;\n            Audio.unpause();\n        }\n\n        handleInput() {\n            if (Input.pointer) {\n                let xy = uv2xy(Input.pointer);\n                let qr = xy2qr(xy);\n                this.gridHovered = qr;\n\n                if (Input.pressed[Input.Action.ATTACK]) {\n                    this.gridSelected = qr;\n                }\n            } else {\n                this.gridHovered = undefined;\n            }\n        }\n\n        startSession() {\n            this.menu = undefined;\n            this.session = new Session();\n        }\n\n        showMainMenu() {\n            this.menu = new MainMenu();\n            this.session = undefined;\n        }\n\n        showInstructions() {\n            this.menu = new InstructionsMenu();\n            this.session = undefined;\n        }\n    }\n\n    const game = new Game();\n\n    /**\n     * Create and launch game.\n     */\n    game.init();\n\n}());\n"]}